<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:site_name" content="Taction Blog"><meta property="og:type" content="article"><meta property="og:image" content="https://taction.top/img/astronaut-moon.jpeg"><meta property="twitter:image" content="https://taction.top/img/astronaut-moon.jpeg"><meta name=title content="一次关于sidecar的问题排查"><meta property="og:title" content="一次关于sidecar的问题排查"><meta property="twitter:title" content="一次关于sidecar的问题排查"><meta name=description content="云原生，WebAssembly, 开源爱好者，生活探险家 | 这里是 张超 的博客，与你一起发现更大的世界。"><meta property="og:description" content="云原生，WebAssembly, 开源爱好者，生活探险家 | 这里是 张超 的博客，与你一起发现更大的世界。"><meta property="twitter:description" content="云原生，WebAssembly, 开源爱好者，生活探险家 | 这里是 张超 的博客，与你一起发现更大的世界。"><meta property="twitter:card" content="summary"><meta name=keyword content="云原生, Dapr, Knative, WebAssembly, Kubernetes, 微服务, Microservice"><link rel="shortcut icon" href=/img/favicon.ico><title>一次关于sidecar的问题排查 | 张超的博客 | Taction Blog</title><link rel=canonical href=/2021/11/20/2021-11-20-acpuquestion.md/><link rel=stylesheet href=/css/bootstrap.min.css><link rel=stylesheet href=/css/hugo-theme-cleanwhite.min.css><link rel=stylesheet href=/css/zanshang.css><link rel=stylesheet href=/css/font-awesome.all.min.css><script src=/js/jquery.min.js></script>
<script src=/js/bootstrap.min.js></script>
<script src=/js/hux-blog.min.js></script>
<script src=/js/lazysizes.min.js></script></head><script async src="https://www.googletagmanager.com/gtag/js?id=G-QD2WJGC9VP"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-QD2WJGC9VP",{anonymize_ip:!1})}</script><nav class="navbar navbar-default navbar-custom navbar-fixed-top"><div class=container-fluid><div class="navbar-header page-scroll"><button type=button class=navbar-toggle>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span></button>
<a class=navbar-brand href=/>Taction Blog</a></div><div id=huxblog_navbar><div class=navbar-collapse><ul class="nav navbar-nav navbar-right"><li><a href=/>All Posts</a></li><li><a href=/categories/tech/>tech</a></li><li><a href=/about//>ABOUT</a></li><li><a href=/search><i class="fa fa-search"></i></a></li></ul></div></div></div></nav><script>var $body=document.body,$toggle=document.querySelector(".navbar-toggle"),$navbar=document.querySelector("#huxblog_navbar"),$collapse=document.querySelector(".navbar-collapse");$toggle.addEventListener("click",handleMagic);function handleMagic(){$navbar.className.indexOf("in")>0?($navbar.className=" ",setTimeout(function(){$navbar.className.indexOf("in")<0&&($collapse.style.height="0px")},400)):($collapse.style.height="auto",$navbar.className+=" in")}</script><style type=text/css>header.intro-header{background-image:url(/img/astronaut-moon.jpeg)}</style><header class=intro-header><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=post-heading><div class=tags><a class=tag href=/tags/go title=go>go</a></div><h1>一次关于sidecar的问题排查</h1><h2 class=subheading>公司采用了自研的sidecar，是用go语言实现的，在部署的时候限制了sidecar的CPU占用为0.5核。且在sidecar中实现了从`/proc/stat`中实时采集sidecar CPU和内存占用并上报的逻辑。在一次版本更新过后，从监控指标上发现sidecar存在异常的CPU毛刺。公司总共有3千多微服务，其中部分流量非常低，但是所有服务都会偶发且无规律的出现CPU占用达到上限的情况。有的持续几ms，有的持续1-2s，虽然每个服务每天可能只有几次，考虑微服务数量就会每分钟都会有几条。</h2><span class=meta>Posted by
Taction
on
Saturday, November 20, 2021</span></div></div></div></div></header><article><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
post-container"><h3 id=问题描述>问题描述</h3><p>公司采用了自研的sidecar，是用go语言实现的，在部署的时候限制了sidecar的CPU占用为0.5核。且在sidecar中实现了从<code>/proc/stat</code>中实时采集sidecar CPU和内存占用并上报的逻辑。在一次版本更新过后，从监控指标上发现sidecar存在异常的CPU毛刺。公司总共有3千多微服务，其中部分流量非常低，但是所有服务都会偶发且无规律的出现CPU占用达到上限的情况。有的持续几ms，有的持续1-2s，虽然每个服务每天可能只有几次，考虑微服务数量就会每分钟都会有几条。</p><p>而且这个现象针对单个服务来看具有偶发性和随机性，跟内存和网络io的特征都不匹配。没法确定是由于什么原因导致的，这样一是没有太好的排查思路，二是也没有办法通过某种特征来判断接下来会发生CPU占用高的情况，从而导致后面的分析都只能是从发生了CPU占用开始分析，而不能抓取到将要发生时的各项指标。</p><p>由于此次更新的代码基本上都是我提交的，而且对比之前的监控指标，发现也会有此现象但是触发频率低很多。由于代码更新量不大，所以第一反应是把自己的代码又从头到尾看了一遍。十分确定没有任何问题，看起来最有可能导致问题的也只是引入了两个常驻协程，对于异常和泄露的场景也都是有考虑的。</p><h4 id=pprof抓取cpu占用>pprof抓取CPU占用</h4><p>sidecar是有pprof端口的，而且在CPU占用过高的时候是有日志的，而且有时持续时间长达几秒，为我们抓取CPU占用提供了可能性。接下来实现了一个简单的脚本，每当发生此情况的时候获取 CPU profile。选取一个抓取到信息的其调用栈如下所示：</p><p><img src="https://www.notion.so/image/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F84484c0c-d633-4d6b-af88-6c1d7af2f486%2FUntitled.png?table=block&amp;id=ff1eccd2-2051-41a6-9bac-69da0990f548&amp;spaceId=f8cc2f76-a72c-46dc-97ca-570846beea3f&amp;width=2000&amp;userId=e6d95cb5-99c7-4b94-805e-7050fb0e6859&amp;cache=v2" alt=img></p><p>问题的主要难点在于pprof抓到的函数占用没有业务代码，完全是go运行时。顿时心里破大防了，不要慌问题不大，反正都这样了，慌也没有用。</p><p><img src=https://image-1255620078.cos.ap-nanjing.myqcloud.com/IMG_2682.JPG alt=IMG_2682></p><p>接下来就只能面向谷歌先看下有没有类似的问题，再看下这些函数具体作用是什么，什么情况下go runtime findrunnable（schedule）会占用CPU过高。经过浏览器不懈的努力，找到了一些信息<a href=https://gobea.cn/blog/detail/OrJAMa6d.html>golang runtime.findrunnable epoll_wait lock 占用CPU 过多排查</a>、<a href=https://groups.google.com/g/golang-nuts/c/6zKXeCoT2LM>slow down 10+ times, what happen to runtime.findrunnable?</a>，甚至第一个问题的CPU占用跟我们的几乎一模一样，但是都是只提出了问题，没有最终的解答。最终在go issue里找到一个看起来有点关系，也不能说是完全没用的<a href=https://github.com/golang/go/issues/18237#issuecomment-265617249>信息</a>：</p><pre tabindex=0><code>Update: most of the scheduler activity is caused by blocking network reads.

The call chain goes across two call stacks, which makes it a little tough to track down through stack traces alone, but here it is:

net.(*netFD).Read
net.(*pollDesc).wait
net.(*pollDesc).waitRead
net.runtime_pollWait
runtime.netpollblock
runtime.gopark
runtime.mcall(park_m)
runtime.park_m
runtime.schedule
runtime.findrunnable
(etc)
The raw call counts suggest that roughly 90% of the runtime.schedule calls are a consequence of this particular chain of events.

@davecheney I haven&#39;t extracted our profile format into the pprof format yet, but I hope that answers the same question you were hoping the svg web would answer.
</code></pre><p>这里出现了我们在pprof文件里的占用时间大头的函数<code>runtime.mcall(park_m)</code>、<code>runtime.park_m</code>、<code>runtime.schedule</code>、<code>runtime.findrunnable</code>！！！虽然这里没有告诉我们究竟为什么。但是告诉了我们几个关键信息，1. 这是个调度问题，而且举的例子是发生在不同的goruntine切换执行的时候。2. 这种情况阻塞等待读取网络内容的时候。在我的问题中这是一个异常现象，这里告诉我们网络可能会引起这个现象，但是没有告诉我们为什么会引起这个现象。</p><p>问题似乎在这个时候陷入了瓶颈，难道要先把go的调度原理啃下来才能解决这个问题吗？那得到猴年马月去啊。这个时候脑子里其实隐约有点感觉，但是说不太清，反正这是一个关于go 调度上的问题，于是就继续查阅了一些资料。加上之前看小黄书的时候，里面完整的介绍过go的GMP模型。而且这可能跟程序运行在容器里相关。于是继续查阅go在容器里调度或者运行时或者routine相关的信息。最终形成了一个可能的怀疑方向：</p><p>就是由于P（理论值应该等于CPU核数）数量设置的不正确，获取的是机器的CPU核数（8），但是实际上应该获取给sidecar的CPU核数（1）。我觉得简单打个比方就是实际上只有一个物理线程，但是go调度器以为有8个物理线程，当新的并发来的时候，假设1个物理线程已经被占用了，但是go以为还可以继续运行新来的协程，就会为它寻找可用线程，但是没有了可能找不到，就可能在这个地方导致CPU空转或者阻塞。</p><p><a href=https://pandaychen.github.io/2020/02/28/GOMAXPROCS-POT/>GOMAXPROCS 的坑</a></p><p><a href=https://blog.csdn.net/weixin_39643189/article/details/109785603>cpu使用率_Go服务在容器内CPU使用率异常问题排查手记_weixin_39643189的博客-CSDN博客</a></p><h3 id=解决方案>解决方案</h3><p>在容器中打印不做任何处理时P数量，跟我们设想的是一致的，获取的机器核数量。接下来就比较简单了，获取容器中被限制的具体的CPU核数有比较成熟的库<a href=https://github.com/uber-go/automaxprocs>uber-go/automaxprocs</a>，在使用之前大概对库的代码原理做了了解，并通过模型试验确认在当前条件下这个库是可以正常工作的，且对于边界条件（小于1核）情况已经做了对应的处理。这里有一个对<a href=https://pandaychen.github.io/2020/02/29/AUTOMAXPROCS-ANALYSIS/>Uber-Automaxprocs 的代码分析</a>。</p><h5 id=后记>后记</h5><p>在后来看到dapr中有一个issue <a href=https://github.com/dapr/dapr/issues/3759>daprd runtime handles logic server request to cost too much time occasionally</a> 。看到这个issue的时候就感觉世界线闭合了，很可能是同样的问题，于是提了一个pr并且得到反馈应该是解决了这个issue。而且还记得我们第一次看到的go issue里的回复吗？这个现象通常会由网络引起！其实根因还是在于协程调度会出问题，之所以在网络情景下明显，是因为网络必然伴随着协程的调度。</p><hr><ul class=pager><li class=previous><a href=/2021/11/04/2021-11-04-debug-knative.md/ data-toggle=tooltip data-placement=top title="Debug Knative">&larr;
Previous Post</a></li><li class=next><a href=/2021/12/01/2021-12-01-knative-crd.md/ data-toggle=tooltip data-placement=top title="Knative CRD">Next
Post &rarr;</a></li></ul></div><div class="col-lg-2 col-lg-offset-0
visible-lg-block
sidebar-container
catalog-container"><div class=side-catalog><hr class="hidden-sm hidden-xs"><h5><a class=catalog-toggle href=#>CATALOG</a></h5><ul class=catalog-body></ul></div></div><div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
sidebar-container"><section><hr class="hidden-sm hidden-xs"><h5><a href=/tags/>FEATURED TAGS</a></h5><div class=tags><a href=/tags/dapr title=dapr>dapr</a>
<a href=/tags/knative title=knative>knative</a>
<a href=/tags/spin title=spin>spin</a>
<a href=/tags/wasmcloud title=wasmcloud>wasmcloud</a>
<a href=/tags/webassembly title=webassembly>webassembly</a></div></section></div></div></div></article><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center"><li><a href=mailto:zchao9100@gmail.com><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fas fa-envelope fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=https://github.com/taction><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-github fa-stack-1x fa-inverse"></i></span></a></li><li><a href rel=alternate type=application/rss+xml title="Taction Blog"><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fas fa-rss fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="copyright text-muted">Copyright &copy; Taction Blog 2023<br><a href=https://themes.gohugo.io/hugo-theme-cleanwhite>CleanWhite Hugo Theme</a> by <a href=https://zhaohuabing.com>Huabing</a> |
<iframe style=margin-left:2px;margin-bottom:-5px frameborder=0 scrolling=0 width=100px height=20px src="https://ghbtns.com/github-btn.html?user=zhaohuabing&repo=hugo-theme-cleanwhite&type=star&count=true"></iframe></p></div></div></div></footer><script>function loadAsync(e,t){var s=document,o="script",n=s.createElement(o),i=s.getElementsByTagName(o)[0];n.src=e,t&&n.addEventListener("load",function(e){t(null,e)},!1),i.parentNode.insertBefore(n,i)}</script><script>$("#tag_cloud").length!==0&&loadAsync("/js/jquery.tagcloud.js",function(){$.fn.tagcloud.defaults={color:{start:"#bbbbee",end:"#0085a1"}},$("#tag_cloud a").tagcloud()})</script><script>loadAsync("https://cdn.jsdelivr.net/npm/fastclick@1.0.6/lib/fastclick.min.js",function(){var e=document.querySelector("nav");e&&FastClick.attach(e)})</script><script type=text/javascript>function generateCatalog(e){_containerSelector="div.post-container";var t,n,s,o,i,a=$(_containerSelector),r=a.find("h1,h2,h3,h4,h5,h6");return $(e).html(""),r.each(function(){t=$(this).prop("tagName").toLowerCase(),o="#"+$(this).prop("id"),n=$(this).text(),i=$('<a href="'+o+'" rel="nofollow">'+n+"</a>"),s=$('<li class="'+t+'_nav"></li>').append(i),$(e).append(s)}),!0}generateCatalog(".catalog-body"),$(".catalog-toggle").click(function(e){e.preventDefault(),$(".side-catalog").toggleClass("fold")}),loadAsync("/js/jquery.nav.js",function(){$(".catalog-body").onePageNav({currentClass:"active",changeHash:!1,easing:"swing",filter:"",scrollSpeed:700,scrollOffset:0,scrollThreshold:.2,begin:null,end:null,scrollChange:null,padding:80})})</script></body></html>